---
title: "Project 1 Markdown"
author: "Rachel Keller"
date: "9/16/2020"
output: rmarkdown::github_document
---

# Requred Packages

Required packages for this vignette are `httr`, `jsonlite`, and `tidyverse`. We will now load in these packages. 
```{r, message = FALSE, warning = FALSE}
library(httr)
library(jsonlite)
library(tidyverse)
```

# Functions

In this section, we will create the functions that will contact the NHL Records API and NHL Stats API, and return parsed data for certain endpoints.

## Franchise Endpoint

The function below will return the franchise endpoint from the NHL Records API, given either the team name or team number/id.
```{r}
getFranchise <- function(teamName = NA, teamNumber = NA){
  baseURLNHLRecords <- "https://records.nhl.com/site/api"
  tableName <- "franchise"
  fullURL <- paste0(baseURLNHLRecords, "/", tableName)
  get <- GET(fullURL)
  txt <- content(get, "text", encoding = "UTF-8")
  json <- fromJSON(txt, flatten=TRUE)
  if(is.na(teamName) & is.na(teamNumber)){
    result <- json$data
  }
  else if (is.na(teamName)){
    result <- json$data %>% mutate(fullName = paste(teamPlaceName, teamCommonName, sep = " ")) %>% filter(id == teamNumber)
  }
  else {
    result <- json$data %>% mutate(fullName = paste(teamPlaceName, teamCommonName, sep = " ")) %>% filter(fullName == teamName)
  }
  return(result)
}
```

## Franchise Team Totals

The function below will return the franchise team totals endpoint from the NHL Records API, given either the team name or team number/id.
```{r}
getFranchiseTotals <- function(teamName = NA, teamNumber = NA){
  baseURLNHLRecords <- "https://records.nhl.com/site/api"
  tableName <- "franchise-team-totals "
  fullURL <- paste0(baseURLNHLRecords, "/", tableName)
  get <- GET(fullURL)
  txt <- content(get, "text", encoding = "UTF-8")
  json <- fromJSON(txt, flatten=TRUE)
  if(is.na(teamName) & is.na(teamNumber)){
    result <- json$data
  }
  else if (is.na(teamName)){
    result <- json$data %>% filter(franchiseId == teamNumber)
  }
  else {
    teamNameValue <- teamName
    result <- json$data %>% filter(teamName == teamNameValue)
  }
  return(result)
}
```

## Franchise Season Records

The function below will return the franchise season records endpoint from the NHL Records API, given either the team name or team number/id.
```{r}
getFranchiseSeasonRecords <- function(teamName = NA, teamNumber = NA){
  baseURLNHLRecords <- "https://records.nhl.com/site/api"
  tableName <- "franchise-season-records?cayenneExp=franchiseId="
  if(is.na(teamName) & is.na(teamNumber)){
    result <- "Error, need to specify a franchise ID or name. "
  }
  else if (is.na(teamName)){
    id <- teamNumber
    fullURL <- paste0(baseURLNHLRecords, "/", tableName, id)
    get <- GET(fullURL)
    txt <- content(get, "text", encoding = "UTF-8")
    json <- fromJSON(txt, flatten=TRUE)
    result <- json$data
  }
  else {
    teamInfo <- getFranchise(teamName = teamName)
    id <- teamInfo$id
    fullURL <- paste0(baseURLNHLRecords, "/", tableName, id)
    get <- GET(fullURL)
    txt <- content(get, "text", encoding = "UTF-8")
    json <- fromJSON(txt, flatten=TRUE)
    result <- json$data
  }
  return(result)
}
```

## Franchise Goalie Records

The function below will return the goalie records endpoint from the NHL Records API, given either the team name or team number/id.
```{r}
getGoalieRecords <- function(teamName = NA, teamNumber = NA){
  baseURLNHLRecords <- "https://records.nhl.com/site/api"
  tableName <- "franchise-goalie-records?cayenneExp=franchiseId="
  if(is.na(teamName) & is.na(teamNumber)){
    result <- "Error, need to specify a franchise ID or name. "
  }
  else if (is.na(teamName)){
    id <- teamNumber
    fullURL <- paste0(baseURLNHLRecords, "/", tableName, id)
    get <- GET(fullURL)
    txt <- content(get, "text", encoding = "UTF-8")
    json <- fromJSON(txt, flatten=TRUE)
    result <- json$data
  }
  else {
    teamInfo <- getFranchise(teamName = teamName)
    id <- teamInfo$id
    fullURL <- paste0(baseURLNHLRecords, "/", tableName, id)
    get <- GET(fullURL)
    txt <- content(get, "text", encoding = "UTF-8")
    json <- fromJSON(txt, flatten=TRUE)
    result <- json$data
  }
  return(result)
}
```

## Franchise Skater Records

The function below will return the skater records endpoint from the NHL Records API, given either the team name or team number/id.
```{r}
getSkaterRecords <- function(teamName = NA, teamNumber = NA){
  baseURLNHLRecords <- "https://records.nhl.com/site/api"
  tableName <- "franchise-skater-records?cayenneExp=franchiseId="
  if(is.na(teamName) & is.na(teamNumber)){
    result <- "Error, need to specify a franchise ID or name. "
  }
  else if (is.na(teamName)){
    id <- teamNumber
    fullURL <- paste0(baseURLNHLRecords, "/", tableName, id)
    get <- GET(fullURL)
    txt <- content(get, "text", encoding = "UTF-8")
    json <- fromJSON(txt, flatten=TRUE)
    result <- json$data
  }
  else {
    teamInfo <- getFranchise(teamName = teamName)
    id <- teamInfo$id
    fullURL <- paste0(baseURLNHLRecords, "/", tableName, id)
    get <- GET(fullURL)
    txt <- content(get, "text", encoding = "UTF-8")
    json <- fromJSON(txt, flatten=TRUE)
    result <- json$data
  }
  return(result)
}
```

## Teams

The function below will return the teams endpoint from the NHL Stats API, given either the team name or team number/id.
```{r}
getTeams <- function(teamName = NA, teamNumber = NA){
  baseURLNHLStats <- "https://statsapi.web.nhl.com/api/v1"
  tableName <- "teams"
  fullURL <- paste0(baseURLNHLStats, "/", tableName)
  get <- GET(fullURL)
  txt <- content(get, "text")
  json <- fromJSON(txt, flatten=TRUE)
  if(is.na(teamName) & is.na(teamNumber)){
    result <- json$teams
  }
  else if (is.na(teamName)){
    result <- json$teams %>% filter(franchiseId == teamNumber)
  }
  else {
    teamNameValue <- teamName
    result <- json$teams %>% filter(name == teamNameValue)
  }
  return(result)
}
```

## Wrapper

Now, we will create our wrapper function. The user can select their desired endpoint. 
```{r}
getEndpoint <- function(endpoint, teamName = NA, teamNumber = NA){
  if(endpoint == "franchise"){
    result <- getFranchise(teamName, teamNumber)
  } else if (endpoint == "franchise totals"){
    result <- getFranchiseTotals(teamName, teamNumber)
  } else if (endpoint == "franchise season records"){
    result <- getFranchiseSeasonRecords(teamName, teamNumber)
  } else if (endpoint == "goalie records"){
    result <- getGoalieRecords(teamName, teamNumber)
  } else if (endpoint == "skater records"){
    result <- getSkaterRecords(teamName, teamNumber)
  } else if (endpoint == "teams"){
    result <- getTeams(teamName, teamNumber)
  } else {
    result <- "Error, incorrect endpoint."
  }
  return(result)
}
```

# Exploratory Data Analysis

Now that we have all of functions created to contact various endpoints in our APIs, we will begin exploring our data. 

More likely to win a shootout
Franchise totals data
Create boxplot
create new variable
```{r, warning = FALSE}
shootout <- getEndpoint("franchise totals") %>% mutate(propShootouts = shootoutWins / (shootoutWins + shootoutLosses), na.rm=TRUE)
g <- ggplot(shootout, aes(X = teamName, y = propShootouts, fill = teamName))
g + geom_boxplot()
```

Contingency table with home losses and road losses from franchise totals

```{r}
losses <- getEndpoint("franchise totals", teamName = "Washington Capitals")
table(losses$gameTypeId, losses$points)
```


Grab division/conference from teams and wins from franchise totals and make bar plot of wins

```{r}
divisions <- getEndpoint("teams")
joined <- full_join(divisions, shootout, by = "franchiseId")
g <- ggplot(joined, aes(x = teamName.y))
g + geom_bar() + facet_wrap(~conference)
```


Use skater records for capitals and make histogram of seasons
Skater records data
Histogram
```{r}
seasons <- getEndpoint("skater records", teamName = "Washington Capitals")
g <- ggplot(seasons, aes(x = seasons))
g + geom_histogram(binwidth = 3)
```


Use skater records for capitals and make histogram of seasons
Goalie records data
Histogram
```{r}
seasons <- getEndpoint("goalie records", teamName = "Washington Capitals")
g <- ggplot(seasons, aes(x = seasons))
g + geom_histogram(binwidth = 3)
```


Make scatterplot of with franchise season records of win streak vs loss streak

```{r}
winStreak <- getEndpoint("franchise season records", teamName = "Washington Capitals")
```


numerical summary of 